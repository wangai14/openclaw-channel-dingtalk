# DingTalk Channel for OpenClaw

é’‰é’‰ä¼ä¸šå†…éƒ¨æœºå™¨äºº Channel æ’ä»¶ï¼Œä½¿ç”¨ Stream æ¨¡å¼ï¼ˆæ— éœ€å…¬ç½‘ IPï¼‰ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **Stream æ¨¡å¼** â€” WebSocket é•¿è¿æ¥ï¼Œæ— éœ€å…¬ç½‘ IP æˆ– Webhook
- âœ… **ç§èŠæ”¯æŒ** â€” ç›´æ¥ä¸æœºå™¨äººå¯¹è¯
- âœ… **ç¾¤èŠæ”¯æŒ** â€” åœ¨ç¾¤é‡Œ @æœºå™¨äºº
- âœ… **å¤šç§æ¶ˆæ¯ç±»å‹** â€” æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ï¼ˆè‡ªå¸¦è¯†åˆ«ï¼‰ã€è§†é¢‘ã€æ–‡ä»¶
- âœ… **Markdown å›å¤** â€” æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼å›å¤
- âœ… **äº’åŠ¨å¡ç‰‡** â€” æ”¯æŒæµå¼æ›´æ–°ï¼Œé€‚ç”¨äº AI å®æ—¶è¾“å‡º
- âœ… **å®Œæ•´ AI å¯¹è¯** â€” æ¥å…¥ Clawdbot æ¶ˆæ¯å¤„ç†ç®¡é“

## å®‰è£…

### æ–¹æ³• Aï¼šé€šè¿‡ npm åŒ…å®‰è£… (æ¨è)

æ‰‹åŠ¨é€šè¿‡ npm åŒ…åå®‰è£…ï¼š

```bash
openclaw plugins install @soimy/dingtalk
```

### æ–¹æ³• Bï¼šé€šè¿‡æœ¬åœ°æºç å®‰è£…

å¦‚æœä½ æƒ³å¯¹æ’ä»¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œå¯ä»¥å…ˆå…‹éš†ä»“åº“ï¼š

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/soimy/openclaw-channel-dingtalk.git
cd openclaw-channel-dingtalk

# 2. å®‰è£…ä¾èµ– (å¿…éœ€)
npm install

# 3. ä»¥é“¾æ¥æ¨¡å¼å®‰è£… (æ–¹ä¾¿ä¿®æ”¹ä»£ç åå®æ—¶ç”Ÿæ•ˆ)
openclaw plugins install -l .
```

### æ–¹æ³• Cï¼šæ‰‹åŠ¨å®‰è£…

1. å°†æœ¬ç›®å½•ä¸‹è½½æˆ–å¤åˆ¶åˆ° `~/.openclaw/extensions/dingtalk`ã€‚
2. ç¡®ä¿åŒ…å« `index.ts`, `openclaw.plugin.json` å’Œ `package.json`ã€‚
3. è¿è¡Œ `openclaw plugins list` ç¡®è®¤ `dingtalk` å·²æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ã€‚

### å®‰è£…åå¿…åšï¼šé…ç½®æ’ä»¶ä¿¡ä»»ç™½åå•ï¼ˆ`plugins.allow`ï¼‰

ä» OpenClaw æ–°ç‰ˆæœ¬å¼€å§‹ï¼Œå¦‚æœå‘ç°äº†éå†…ç½®æ’ä»¶ä¸” `plugins.allow` ä¸ºç©ºï¼Œä¼šæç¤ºï¼š

```text
[plugins] plugins.allow is empty; discovered non-bundled plugins may auto-load ...
```

è¿™æ˜¯ä¸€æ¡å®‰å…¨å‘Šè­¦ï¼ˆä¸æ˜¯å®‰è£…å¤±è´¥ï¼‰ï¼Œå»ºè®®æ˜¾å¼å†™å…¥ä½ ä¿¡ä»»çš„æ’ä»¶ idã€‚

#### æ­¥éª¤ 1ï¼šç¡®è®¤æ’ä»¶ id

æœ¬æ’ä»¶ id å›ºå®šä¸ºï¼š`dingtalk`ï¼ˆå®šä¹‰äº `openclaw.plugin.json`ï¼‰ã€‚

ä¹Ÿå¯ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹å·²å‘ç°æ’ä»¶ï¼š

```bash
openclaw plugins list
```

#### æ­¥éª¤ 2ï¼šåœ¨ `~/.openclaw/openclaw.json` æ·»åŠ  `plugins.allow`

```json5
{
  "plugins": {
    "enabled": true,
    "allow": ["dingtalk"]
  }
}
```

å¦‚æœä½ è¿˜æœ‰å…¶ä»–å·²å®‰è£…ä¸”éœ€è¦å¯ç”¨çš„æ’ä»¶ï¼Œè¯·ä¸€å¹¶åŠ å…¥ï¼Œä¾‹å¦‚ï¼š

```json5
{
  "plugins": {
    "allow": ["dingtalk", "telegram", "voice-call"]
  }
}
```

#### æ­¥éª¤ 3ï¼šé‡å¯ Gateway

```bash
openclaw gateway restart
```

> æ³¨æ„ï¼šå¦‚æœä½ ä¹‹å‰å·²ç»é…ç½®è¿‡ `plugins.allow`ï¼Œä½†æ²¡æœ‰ `dingtalk`ï¼Œé‚£ä¹ˆæ’ä»¶ä¸ä¼šè¢«åŠ è½½ã€‚è¯·æŠŠ `dingtalk` åŠ å…¥è¯¥åˆ—è¡¨ã€‚

## æ›´æ–°

`openclaw plugins update` ä½¿ç”¨æ’ä»¶ idï¼ˆä¸æ˜¯ npm åŒ…åï¼‰ï¼Œå¹¶ä¸”ä»…é€‚ç”¨äº npm å®‰è£…æ¥æºã€‚

å¦‚æœä½ æ˜¯é€šè¿‡ npm å®‰è£…æœ¬æ’ä»¶ï¼š

```bash
openclaw plugins update dingtalk
```

å¦‚æœä½ æ˜¯æœ¬åœ°æºç /é“¾æ¥å®‰è£…ï¼ˆ`openclaw plugins install -l .`ï¼‰ï¼Œè¯·åœ¨æ’ä»¶ç›®å½•æ›´æ–°ä»£ç åé‡å¯ Gatewayï¼š

```bash
git pull
openclaw gateway restart
```

## é…ç½®

OpenClaw æ”¯æŒ**äº¤äº’å¼é…ç½®**å’Œ**æ‰‹åŠ¨é…ç½®æ–‡ä»¶**ä¸¤ç§æ–¹å¼ã€‚

### æ–¹æ³• 1ï¼šäº¤äº’å¼é…ç½®ï¼ˆæ¨èï¼‰

ä½¿ç”¨ OpenClaw å‘½ä»¤è¡Œå‘å¯¼å¼é…ç½®æ’ä»¶å‚æ•°ï¼š

```bash
# æ–¹å¼ Aï¼šä½¿ç”¨ onboard å‘½ä»¤
openclaw onboard

# æ–¹å¼ Bï¼šç›´æ¥é…ç½® channels éƒ¨åˆ†
openclaw configure --section channels
```

äº¤äº’å¼é…ç½®æµç¨‹ï¼š

1. **é€‰æ‹©æ’ä»¶** â€” åœ¨æ’ä»¶åˆ—è¡¨ä¸­é€‰æ‹© `dingtalk` æˆ– `DingTalk (é’‰é’‰)`
2. **Client ID** â€” è¾“å…¥é’‰é’‰åº”ç”¨çš„ AppKey
3. **Client Secret** â€” è¾“å…¥é’‰é’‰åº”ç”¨çš„ AppSecret
4. **å®Œæ•´é…ç½®** â€” å¯é€‰é…ç½® Robot Codeã€Corp IDã€Agent IDï¼ˆæ¨èï¼‰
5. **å¡ç‰‡æ¨¡å¼** â€” å¯é€‰å¯ç”¨ AI äº’åŠ¨å¡ç‰‡æ¨¡å¼
   - å¦‚å¯ç”¨ï¼Œéœ€è¾“å…¥ Card Template ID å’Œ Card Template Key
6. **ç§èŠç­–ç•¥** â€” é€‰æ‹© `open`ï¼ˆå¼€æ”¾ï¼‰æˆ– `allowlist`ï¼ˆç™½åå•ï¼‰
7. **ç¾¤èŠç­–ç•¥** â€” é€‰æ‹© `open`ï¼ˆå¼€æ”¾ï¼‰æˆ– `allowlist`ï¼ˆç™½åå•ï¼‰

> æ‰€æœ‰çš„å‚æ•°å‚è€ƒä¸‹æ–‡ä¸­çš„é’‰é’‰å¼€å‘è€…å¹³å°é…ç½®æŒ‡å—

é…ç½®å®Œæˆåä¼šè‡ªåŠ¨ä¿å­˜å¹¶é‡å¯ Gatewayã€‚

---

#### é’‰é’‰å¼€å‘è€…å¹³å°é…ç½®æŒ‡å—

##### 1. åˆ›å»ºé’‰é’‰åº”ç”¨

1. è®¿é—® [é’‰é’‰å¼€å‘è€…åå°](https://open-dev.dingtalk.com/)
2. åˆ›å»ºä¼ä¸šå†…éƒ¨åº”ç”¨
3. æ·»åŠ ã€Œæœºå™¨äººã€èƒ½åŠ›
4. é…ç½®æ¶ˆæ¯æ¥æ”¶æ¨¡å¼ä¸º **Stream æ¨¡å¼**
5. å‘å¸ƒåº”ç”¨

##### 2. é…ç½®æƒé™ç®¡ç†

åœ¨åº”ç”¨çš„æƒé™ç®¡ç†é¡µé¢ï¼Œéœ€è¦å¼€å¯ä»¥ä¸‹æƒé™ï¼š

- âœ… **Card.Instance.Write** â€” åˆ›å»ºå’ŒæŠ•æ”¾å¡ç‰‡å®ä¾‹
- âœ… **Card.Streaming.Write** â€” å¯¹å¡ç‰‡è¿›è¡Œæµå¼æ›´æ–°

**æ­¥éª¤ï¼š**

1. è¿›å…¥åº”ç”¨ â†’ æƒé™ç®¡ç†
2. æœç´¢ã€ŒCardã€ç›¸å…³æƒé™
3. å‹¾é€‰ä¸Šè¿°ä¸¤ä¸ªæƒé™
4. ä¿å­˜æƒé™é…ç½®

##### 3. å»ºç«‹å¡ç‰‡æ¨¡æ¿(å¯é€‰)

**æ­¥éª¤ï¼š**

1. è®¿é—® [é’‰é’‰å¡ç‰‡å¹³å°](https://open-dev.dingtalk.com/fe/card)
2. è¿›å…¥ã€Œæˆ‘çš„æ¨¡æ¿ã€
3. ç‚¹å‡»ã€Œåˆ›å»ºæ¨¡æ¿ã€
4. å¡ç‰‡æ¨¡æ¿åœºæ™¯é€‰æ‹© **ã€ŒAI å¡ç‰‡ã€**
5. æŒ‰éœ€è®¾è®¡å¡ç‰‡æ’ç‰ˆ,ç‚¹å‡»ä¿å­˜å¹¶å‘å¸ƒ
6. è®°ä¸‹æ¨¡æ¿ä¸­å®šä¹‰çš„å†…å®¹å­—æ®µåç§°
7. å¤åˆ¶æ¨¡æ¿ IDï¼ˆæ ¼å¼å¦‚ï¼š`xxxxx-xxxxx-xxxxx.schema`ï¼‰
8. å°† templateId é…ç½®åˆ° `openclaw.json` çš„ `cardTemplateId` å­—æ®µ
9. æˆ–åœ¨OpenClawæ§åˆ¶å°çš„Channelæ ‡ç­¾->Dingtalké…ç½®é¢æ¿-> Card Template Idå¡«å…¥
10. å°†è®°ä¸‹çš„å†…å®¹å­—æ®µå˜é‡åé…ç½®åˆ° `openclaw.json` çš„ `cardTemplateKey` å­—æ®µ
11. æˆ–åœ¨OpenClawæ§åˆ¶å°çš„Channelæ ‡ç­¾->Dingtalké…ç½®é¢æ¿-> Card Template Keyå¡«å…¥

**è¯´æ˜ï¼š**

- ä½¿ç”¨ DingTalk å®˜æ–¹ AI å¡ç‰‡æ¨¡æ¿æ—¶ï¼Œ`cardTemplateKey` é»˜è®¤ä¸º `'content'`ï¼Œæ— éœ€ä¿®æ”¹
- å¦‚æœæ‚¨åˆ›å»ºè‡ªå®šä¹‰å¡ç‰‡æ¨¡æ¿ï¼Œéœ€è¦ç¡®ä¿æ¨¡æ¿ä¸­åŒ…å«ç›¸åº”çš„å†…å®¹å­—æ®µï¼Œå¹¶å°† `cardTemplateKey` é…ç½®ä¸ºè¯¥å­—æ®µåç§°

##### 4. è·å–å‡­è¯

ä»å¼€å‘è€…åå°è·å–ï¼š

- **Client ID** (AppKey)
- **Client Secret** (AppSecret)
- **Robot Code** (ä¸ Client ID ç›¸åŒ)
- **Corp ID** (ä¼ä¸š ID)
- **Agent ID** (åº”ç”¨ ID)

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨é…ç½®æ–‡ä»¶

åœ¨ `~/.openclaw/openclaw.json` ä¸­æ·»åŠ ï¼ˆä»…ä½œå‚è€ƒï¼Œäº¤äº’å¼é…ç½®ä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š

> è‡³å°‘åŒ…å« `plugins.allow` å’Œ `channels.dingtalk` ä¸¤éƒ¨åˆ†ï¼Œå†…å®¹å‚è€ƒä¸Šæ–‡é’‰é’‰å¼€å‘è€…é…ç½®æŒ‡å—

```json5
{
  "plugins": {
    "enabled": true,
    "allow": ["dingtalk"]
  },

  ...
  "channels": {
    "telegram": { ... },

    "dingtalk": {
      "enabled": true,
      "clientId": "dingxxxxxx",
      "clientSecret": "your-app-secret",
      "robotCode": "dingxxxxxx",
      "corpId": "dingxxxxxx",
      "agentId": "123456789",
      "dmPolicy": "open",
      "groupPolicy": "open",
      "debug": false,
      "messageType": "markdown", // æˆ– "card"
      // ä»…cardéœ€è¦é…ç½®
      "cardTemplateId": "ä½ å¤åˆ¶çš„æ¨¡æ¿ID",
      "cardTemplateKey": "ä½ æ¨¡æ¿çš„å†…å®¹å˜é‡"
    }
  },
  ...
}
```

æœ€åé‡å¯ Gateway

> ä½¿ç”¨äº¤äº’å¼é…ç½®æ—¶ï¼ŒGateway ä¼šè‡ªåŠ¨é‡å¯ã€‚ä½¿ç”¨æ‰‹åŠ¨é…ç½®æ—¶éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
openclaw gateway restart
```

## é…ç½®é€‰é¡¹

| é€‰é¡¹                    | ç±»å‹     | é»˜è®¤å€¼       | è¯´æ˜                                        |
| ----------------------- | -------- | ------------ | ------------------------------------------- |
| `enabled`               | boolean  | `true`       | æ˜¯å¦å¯ç”¨                                    |
| `clientId`              | string   | å¿…å¡«         | åº”ç”¨çš„ AppKey                               |
| `clientSecret`          | string   | å¿…å¡«         | åº”ç”¨çš„ AppSecret                            |
| `robotCode`             | string   | -            | æœºå™¨äººä»£ç ï¼ˆç”¨äºä¸‹è½½åª’ä½“å’Œå‘é€å¡ç‰‡ï¼‰        |
| `corpId`                | string   | -            | ä¼ä¸š ID                                     |
| `agentId`               | string   | -            | åº”ç”¨ ID                                     |
| `dmPolicy`              | string   | `"open"`     | ç§èŠç­–ç•¥ï¼šopen/pairing/allowlist            |
| `groupPolicy`           | string   | `"open"`     | ç¾¤èŠç­–ç•¥ï¼šopen/allowlist                    |
| `allowFrom`             | string[] | `[]`         | å…è®¸çš„å‘é€è€… ID åˆ—è¡¨                        |
| `messageType`           | string   | `"markdown"` | æ¶ˆæ¯ç±»å‹ï¼šmarkdown/card                     |
| `cardTemplateId`        | string   |              | AI äº’åŠ¨å¡ç‰‡æ¨¡æ¿ IDï¼ˆä»…å½“ messageType=cardï¼‰ |
| `cardTemplateKey`       | string   | `"content"`  | å¡ç‰‡æ¨¡æ¿å†…å®¹å­—æ®µé”®ï¼ˆä»…å½“ messageType=cardï¼‰ |
| `debug`                 | boolean  | `false`      | æ˜¯å¦å¼€å¯è°ƒè¯•æ—¥å¿—                            |
| `maxConnectionAttempts` | number   | `10`         | æœ€å¤§è¿æ¥å°è¯•æ¬¡æ•°                            |
| `initialReconnectDelay` | number   | `1000`       | åˆå§‹é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰                        |
| `maxReconnectDelay`     | number   | `60000`      | æœ€å¤§é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰                        |
| `reconnectJitter`       | number   | `0.3`        | é‡è¿å»¶è¿ŸæŠ–åŠ¨å› å­ï¼ˆ0-1ï¼‰                     |

### è¿æ¥é²æ£’æ€§é…ç½®

ä¸ºæé«˜è¿æ¥ç¨³å®šæ€§ï¼Œæ’ä»¶æ”¯æŒä»¥ä¸‹é«˜çº§é…ç½®ï¼š

- **maxConnectionAttempts**: è¿æ¥å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¶…è¿‡åå°†åœæ­¢å°è¯•å¹¶æŠ¥è­¦ã€‚
- **initialReconnectDelay**: ç¬¬ä¸€æ¬¡é‡è¿çš„åˆå§‹å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ï¼Œåç»­é‡è¿ä¼šæŒ‰æŒ‡æ•°å¢é•¿ã€‚
- **maxReconnectDelay**: é‡è¿å»¶è¿Ÿçš„ä¸Šé™ï¼ˆæ¯«ç§’ï¼‰ï¼Œé˜²æ­¢ç­‰å¾…æ—¶é—´è¿‡é•¿ã€‚
- **reconnectJitter**: å»¶è¿ŸæŠ–åŠ¨å› å­ï¼Œåœ¨å»¶è¿ŸåŸºç¡€ä¸Šå¢åŠ éšæœºå˜åŒ–ï¼ˆÂ±30%ï¼‰ï¼Œé¿å…å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¿ã€‚

é‡è¿å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼š`delay = min(initialDelay Ã— 2^attempt, maxDelay) Ã— (1 Â± jitter)`

ç¤ºä¾‹å»¶è¿Ÿåºåˆ—ï¼ˆé»˜è®¤é…ç½®ï¼‰ï¼š~1s, ~2s, ~4s, ~8s, ~16s, ~32s, ~60sï¼ˆè¾¾åˆ°ä¸Šé™ï¼‰

æ›´å¤šè¯¦æƒ…è¯·å‚é˜… [CONNECTION_ROBUSTNESS.md](./CONNECTION_ROBUSTNESS.md)ã€‚

## å®‰å…¨ç­–ç•¥

### ç§èŠç­–ç•¥ (dmPolicy)

- `open` â€” ä»»ä½•äººéƒ½å¯ä»¥ç§èŠæœºå™¨äºº
- `pairing` â€” æ–°ç”¨æˆ·éœ€è¦é€šè¿‡é…å¯¹ç éªŒè¯
- `allowlist` â€” åªæœ‰ allowFrom åˆ—è¡¨ä¸­çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨

### ç¾¤èŠç­–ç•¥ (groupPolicy)

- `open` â€” ä»»ä½•ç¾¤éƒ½å¯ä»¥ @æœºå™¨äºº
- `allowlist` â€” åªæœ‰é…ç½®çš„ç¾¤å¯ä»¥ä½¿ç”¨

## æ¶ˆæ¯ç±»å‹æ”¯æŒ

### æ¥æ”¶

| ç±»å‹   | æ”¯æŒ | è¯´æ˜                 |
| ------ | ---- | -------------------- |
| æ–‡æœ¬   | âœ…   | å®Œæ•´æ”¯æŒ             |
| å¯Œæ–‡æœ¬ | âœ…   | æå–æ–‡æœ¬å†…å®¹         |
| å›¾ç‰‡   | âœ…   | ä¸‹è½½å¹¶ä¼ é€’ç»™ AI      |
| è¯­éŸ³   | âœ…   | ä½¿ç”¨é’‰é’‰è¯­éŸ³è¯†åˆ«ç»“æœ |
| è§†é¢‘   | âœ…   | ä¸‹è½½å¹¶ä¼ é€’ç»™ AI      |
| æ–‡ä»¶   | âœ…   | ä¸‹è½½å¹¶ä¼ é€’ç»™ AI      |

### å‘é€

| ç±»å‹     | æ”¯æŒ | è¯´æ˜                             |
| -------- | ---- | -------------------------------- |
| æ–‡æœ¬     | âœ…   | å®Œæ•´æ”¯æŒ                         |
| Markdown | âœ…   | è‡ªåŠ¨æ£€æµ‹æˆ–æ‰‹åŠ¨æŒ‡å®š               |
| äº’åŠ¨å¡ç‰‡ | âœ…   | æ”¯æŒæµå¼æ›´æ–°ï¼Œé€‚ç”¨äº AI å®æ—¶è¾“å‡º |
| å›¾ç‰‡     | â³   | éœ€è¦é€šè¿‡åª’ä½“ä¸Šä¼  API             |

## API æ¶ˆè€—è¯´æ˜

### Text/Markdown æ¨¡å¼

| æ“ä½œ       | API è°ƒç”¨æ¬¡æ•° | è¯´æ˜                                                                         |
| ---------- | ------------ | ---------------------------------------------------------------------------- |
| è·å– Token | 1            | å…±äº«/ç¼“å­˜ï¼ˆ60 ç§’æ£€æŸ¥è¿‡æœŸä¸€æ¬¡ï¼‰                                               |
| å‘é€æ¶ˆæ¯   | 1            | ä½¿ç”¨ `/v1.0/robot/oToMessages/batchSend` æˆ– `/v1.0/robot/groupMessages/send` |
| **æ€»è®¡**   | **2**        | æ¯æ¡å›å¤ 1 æ¬¡                                                                |

### Cardï¼ˆAI äº’åŠ¨å¡ç‰‡ï¼‰æ¨¡å¼

| é˜¶æ®µ         | API è°ƒç”¨               | è¯´æ˜                                                |
| ------------ | ---------------------- | --------------------------------------------------- |
| **åˆ›å»ºå¡ç‰‡** | 1                      | `POST /v1.0/card/instances/createAndDeliver`        |
| **æµå¼æ›´æ–°** | M                      | M = å›å¤å—æ•°é‡ï¼Œæ¯å—ä¸€æ¬¡ `PUT /v1.0/card/streaming` |
| **å®Œæˆå¡ç‰‡** | åŒ…å«åœ¨æœ€åä¸€æ¬¡æµæ›´æ–°ä¸­ | ä½¿ç”¨ `isFinalize=true` æ ‡è®°                         |
| **æ€»è®¡**     | **1 + M**              | M = Agent äº§ç”Ÿçš„å›å¤å—æ•°                            |

### å…¸å‹åœºæ™¯æˆæœ¬å¯¹æ¯”

| åœºæ™¯             | Text/Markdown | Card | èŠ‚çœ   |
| ---------------- | ------------- | ---- | ------ |
| ç®€çŸ­å›å¤ï¼ˆ1 å—ï¼‰ | 2             | 2    | âœ“ ç›¸åŒ |
| ä¸­ç­‰å›å¤ï¼ˆ5 å—ï¼‰ | 6             | 6    | âœ“ ç›¸åŒ |
| é•¿å›å¤ï¼ˆ10 å—ï¼‰  | 12            | 11   | âœ“ 1 æ¬¡ |

### ä¼˜åŒ–ç­–ç•¥

**é™ä½ API è°ƒç”¨çš„æ–¹æ³•ï¼š**

1. **åˆå¹¶å›å¤å—** â€” é€šè¿‡è°ƒæ•´ Agent è¾“å‡ºé…ç½®ï¼Œå‡å°‘å—æ•°é‡
2. **ä½¿ç”¨ç¼“å­˜** â€” Token è‡ªåŠ¨ç¼“å­˜ï¼ˆ60 ç§’ï¼‰ï¼Œæ— éœ€æ¯æ¬¡éƒ½è·å–
3. **Buffer æ¨¡å¼** â€” ä½¿ç”¨ `dispatchReplyWithBufferedBlockDispatcher` åˆå¹¶å¤šä¸ªå°å—

**æˆæœ¬å»ºè®®ï¼š**

- âœ… **æ¨è** â€” Card æ¨¡å¼ï¼šæµå¼ä½“éªŒæ›´å¥½ï¼Œæˆæœ¬ä¸ Text/Markdown ç›¸å½“æˆ–æ›´ä½
- âš ï¸ **è°¨æ…** â€” é¢‘ç¹è°ƒç”¨éœ€è¦ç›‘æµ‹é…é¢ï¼Œå»ºè®®ä½¿ç”¨é’‰é’‰å¼€å‘è€…åå°æŸ¥çœ‹ API è°ƒç”¨é‡

## æ¶ˆæ¯ç±»å‹é€‰æ‹©

æ’ä»¶æ”¯æŒä¸¤ç§æ¶ˆæ¯å›å¤ç±»å‹ï¼Œå¯é€šè¿‡ `messageType` é…ç½®ï¼š

### 1. markdownï¼ˆMarkdown æ ¼å¼ï¼‰**ã€é»˜è®¤ã€‘**

- æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼ï¼ˆæ ‡é¢˜ã€ç²—ä½“ã€åˆ—è¡¨ç­‰ï¼‰
- è‡ªåŠ¨æ£€æµ‹æ¶ˆæ¯æ˜¯å¦åŒ…å« Markdown è¯­æ³•
- é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯

### 2. cardï¼ˆAI äº’åŠ¨å¡ç‰‡ï¼‰

- æ”¯æŒæµå¼æ›´æ–°ï¼ˆå®æ—¶æ˜¾ç¤º AI ç”Ÿæˆå†…å®¹ï¼‰
- æ›´å¥½çš„è§†è§‰å‘ˆç°å’Œäº¤äº’ä½“éªŒ
- æ”¯æŒ Markdown æ ¼å¼æ¸²æŸ“
- é€šè¿‡ `cardTemplateId` æŒ‡å®šæ¨¡æ¿
- é€šè¿‡ `cardTemplateKey` æŒ‡å®šå†…å®¹å­—æ®µ
- **é€‚ç”¨äº AI å¯¹è¯åœºæ™¯**
- æ”¯æŒåœ¨å¡ç‰‡ä¸­å®æ—¶æ˜¾ç¤º AI æ€è€ƒè¿‡ç¨‹ï¼ˆæ¨ç†æµï¼‰å’Œå·¥å…·æ‰§è¡Œç»“æœ

**AI Card API ç‰¹æ€§ï¼š**
å½“é…ç½® `messageType: 'card'` æ—¶ï¼š

1. ä½¿ç”¨ `/v1.0/card/instances/createAndDeliver` åˆ›å»ºå¹¶æŠ•æ”¾å¡ç‰‡
2. ä½¿ç”¨ `/v1.0/card/streaming` å®ç°çœŸæ­£çš„æµå¼æ›´æ–°
3. è‡ªåŠ¨çŠ¶æ€ç®¡ç†ï¼ˆPROCESSING â†’ INPUTING â†’ FINISHEDï¼‰
4. æ›´ç¨³å®šçš„æµå¼ä½“éªŒï¼Œæ— éœ€æ‰‹åŠ¨èŠ‚æµ

### AI æ€è€ƒè¿‡ç¨‹ä¸å·¥å…·æ‰§è¡Œæ˜¾ç¤ºï¼ˆAI Card æ¨¡å¼ï¼‰

å½“ `messageType` ä¸º `card` æ—¶ï¼Œæ’ä»¶å¯ä»¥åœ¨å¡ç‰‡ä¸­å®æ—¶å±•ç¤º AI çš„æ¨ç†è¿‡ç¨‹ï¼ˆğŸ¤” æ€è€ƒä¸­ï¼‰å’Œå·¥å…·è°ƒç”¨ç»“æœï¼ˆğŸ› ï¸ å·¥å…·æ‰§è¡Œï¼‰ã€‚è¿™ä¸¤é¡¹åŠŸèƒ½é€šè¿‡**å¯¹è¯çº§å‘½ä»¤**æ§åˆ¶ï¼Œæ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

| åŠŸèƒ½              | å¯¹è¯å‘½ä»¤              | è¯´æ˜                               |
| ----------------- | --------------------- | ---------------------------------- |
| æ˜¾ç¤º AI æ¨ç†æµ    | `/reasoning stream`   | å¼€å¯åï¼ŒAI æ€è€ƒå†…å®¹å®æ—¶æ›´æ–°åˆ°å¡ç‰‡  |
| æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ  | `/verbose on`         | å¼€å¯åï¼Œå·¥å…·è°ƒç”¨ç»“æœå®æ—¶æ›´æ–°åˆ°å¡ç‰‡ |
| å…³é—­ AI æ¨ç†æµ    | `/reasoning off`      | å…³é—­æ¨ç†æµæ˜¾ç¤º                     |
| å…³é—­å·¥å…·æ‰§è¡Œæ˜¾ç¤º  | `/verbose off`        | å…³é—­å·¥å…·æ‰§è¡Œç»“æœæ˜¾ç¤º               |

**æ˜¾ç¤ºæ ¼å¼ï¼š**

- æ€è€ƒå†…å®¹ä»¥ `ğŸ¤” **æ€è€ƒä¸­**` ä¸ºæ ‡é¢˜ï¼Œæ­£æ–‡ä»¥ `>` å¼•ç”¨å—å±•ç¤ºï¼Œæœ€å¤šæ˜¾ç¤ºå‰ 500 ä¸ªå­—ç¬¦
- å·¥å…·ç»“æœä»¥ `ğŸ› ï¸ **å·¥å…·æ‰§è¡Œ**` ä¸ºæ ‡é¢˜ï¼Œæ­£æ–‡ä»¥ `>` å¼•ç”¨å—å±•ç¤ºï¼Œæœ€å¤šæ˜¾ç¤ºå‰ 500 ä¸ªå­—ç¬¦

> **æ³¨æ„ï¼š** æ¨ç†æµå’Œå·¥å…·æ‰§è¡Œå‡ä¼šäº§ç”Ÿé¢å¤–çš„å¡ç‰‡æµå¼æ›´æ–° API è°ƒç”¨ï¼Œåœ¨ AI æ¨ç†æ­¥éª¤è¾ƒå¤šæ—¶å¯èƒ½æ˜¾è‘—å¢åŠ  API æ¶ˆè€—ï¼Œå»ºè®®æŒ‰éœ€å¼€å¯ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**

```json5
{
  messageType: 'card', // å¯ç”¨ AI äº’åŠ¨å¡ç‰‡æ¨¡å¼
  cardTemplateId: '382e4302-551d-4880-bf29-a30acfab2e71.schema', // AI å¡ç‰‡æ¨¡æ¿ IDï¼ˆé»˜è®¤å€¼ï¼‰
  cardTemplateKey: 'content', // å¡ç‰‡å†…å®¹å­—æ®µé”®ï¼ˆé»˜è®¤å€¼ï¼šcontentï¼‰
}
```

> **æ³¨æ„**ï¼š`cardTemplateKey` åº”ä¸æ‚¨çš„å¡ç‰‡æ¨¡æ¿ä¸­å®šä¹‰çš„å­—æ®µåç§°ä¸€è‡´ã€‚é»˜è®¤å€¼ä¸º `'content'`ï¼Œé€‚ç”¨äº DingTalk å®˜æ–¹ AI å¡ç‰‡æ¨¡æ¿ã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ï¼Œè¯·æ ¹æ®æ¨¡æ¿å®šä¹‰çš„å­—æ®µåç§°è¿›è¡Œé…ç½®ã€‚

## ä½¿ç”¨ç¤ºä¾‹

é…ç½®å®Œæˆåï¼Œç›´æ¥åœ¨é’‰é’‰ä¸­ï¼š

1. **ç§èŠæœºå™¨äºº** â€” æ‰¾åˆ°æœºå™¨äººï¼Œå‘é€æ¶ˆæ¯
2. **ç¾¤èŠ @æœºå™¨äºº** â€” åœ¨ç¾¤é‡Œ @æœºå™¨äººåç§° + æ¶ˆæ¯

## æ•…éšœæ’é™¤

### æ”¶ä¸åˆ°æ¶ˆæ¯

1. ç¡®è®¤åº”ç”¨å·²å‘å¸ƒ
2. ç¡®è®¤æ¶ˆæ¯æ¥æ”¶æ¨¡å¼æ˜¯ Stream
3. æ£€æŸ¥ Gateway æ—¥å¿—ï¼š`openclaw logs | grep dingtalk`

### ç¾¤æ¶ˆæ¯æ— å“åº”

1. ç¡®è®¤æœºå™¨äººå·²æ·»åŠ åˆ°ç¾¤
2. ç¡®è®¤æ­£ç¡® @æœºå™¨äººï¼ˆä½¿ç”¨æœºå™¨äººåç§°ï¼‰
3. ç¡®è®¤ç¾¤æ˜¯ä¼ä¸šå†…éƒ¨ç¾¤

### è¿æ¥å¤±è´¥

1. æ£€æŸ¥ clientId å’Œ clientSecret æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç½‘ç»œå¯ä»¥è®¿é—®é’‰é’‰ API

### é”™è¯¯ payload æ—¥å¿—è§„èŒƒï¼ˆ`[ErrorPayload]`ï¼‰

ä¸ºä¾¿äºå¿«é€Ÿå®šä½ 4xx/5xx å‚æ•°é—®é¢˜ï¼Œæ’ä»¶ä¼šåœ¨ API é”™è¯¯åˆ†æ”¯è¾“å‡ºç»Ÿä¸€æ ¼å¼æ—¥å¿—ï¼š

- é€šç”¨å‰ç¼€ï¼š`[DingTalk][ErrorPayload][<scope>]`
- AI Card å‰ç¼€ï¼š`[DingTalk][AICard][ErrorPayload][<scope>]`
- å†…å®¹æ ¼å¼ï¼š`code=<...> message=<...> payload=<...>`ï¼ˆåŒæ—¶ä¿ç•™è„±æ•åçš„å®Œæ•´ payloadï¼‰

å¸¸è§ scope ç¤ºä¾‹ï¼š

- `send.proactiveMessage` / `send.proactiveMedia` / `send.message`
- `outbound.sendText` / `outbound.sendMedia`
- `inbound.downloadMedia` / `inbound.cardFinalize`
- `card.create` / `card.stream` / `card.stream.retryAfterRefresh`
- `retry.beforeDecision`

æ’æŸ¥å»ºè®®ï¼š

```bash
openclaw logs | grep "\[ErrorPayload\]"
```

å¦‚æœä½ çœ‹åˆ° `code=invalidParameter`ï¼Œé€šå¸¸ä¼˜å…ˆæ£€æŸ¥è¯·æ±‚ payload çš„å¿…å¡«å­—æ®µï¼ˆä¾‹å¦‚ `robotCode`ã€`userIds`ã€`msgKey`ã€`msgParam`ï¼‰æ˜¯å¦å®Œæ•´ä¸”æ ¼å¼æ­£ç¡®ã€‚

## å¼€å‘æŒ‡å—

### é¦–æ¬¡è®¾ç½®

1. å…‹éš†ä»“åº“å¹¶å®‰è£…ä¾èµ–

```bash
git clone https://github.com/soimy/openclaw-channel-dingtalk.git
cd openclaw-channel-dingtalk
npm install
```

2. éªŒè¯å¼€å‘ç¯å¢ƒ

```bash
npm run type-check              # TypeScript ç±»å‹æ£€æŸ¥
npm run lint                    # ESLint ä»£ç æ£€æŸ¥
```

### å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                 | è¯´æ˜                |
| -------------------- | ------------------- |
| `npm run type-check` | TypeScript ç±»å‹æ£€æŸ¥ |
| `npm run lint`       | ESLint ä»£ç æ£€æŸ¥     |
| `npm run lint:fix`   | è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜    |

### é¡¹ç›®ç»“æ„

```
src/
  channel.ts           - æ’ä»¶å®šä¹‰å’Œè¾…åŠ©å‡½æ•°ï¼ˆ535 è¡Œï¼‰
  runtime.ts           - è¿è¡Œæ—¶ç®¡ç†ï¼ˆ14 è¡Œï¼‰
  types.ts             - ç±»å‹å®šä¹‰ï¼ˆ30+ interfacesï¼‰

index.ts              - æ’ä»¶æ³¨å†Œï¼ˆ29 è¡Œï¼‰
utils.ts              - å·¥å…·å‡½æ•°ï¼ˆ110 è¡Œï¼‰

openclaw.plugin.json  - æ’ä»¶é…ç½®
package.json          - é¡¹ç›®é…ç½®
README.md             - æœ¬æ–‡ä»¶
```

### ä»£ç è´¨é‡

- **TypeScript**: ä¸¥æ ¼æ¨¡å¼ï¼Œ0 é”™è¯¯
- **ESLint**: è‡ªåŠ¨æ£€æŸ¥å’Œä¿®å¤
- **Type Safety**: å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼ˆ30+ æ¥å£ï¼‰

### ç±»å‹ç³»ç»Ÿ

æ ¸å¿ƒç±»å‹å®šä¹‰åœ¨ `src/types.ts` ä¸­ï¼ŒåŒ…æ‹¬ï¼š

```typescript
// é…ç½®
DingTalkConfig; // æ’ä»¶é…ç½®
DingTalkChannelConfig; // å¤šè´¦æˆ·é…ç½®

// æ¶ˆæ¯å¤„ç†
DingTalkInboundMessage; // æ”¶åˆ°çš„é’‰é’‰æ¶ˆæ¯
MessageContent; // è§£æåçš„æ¶ˆæ¯å†…å®¹
HandleDingTalkMessageParams; // æ¶ˆæ¯å¤„ç†å‚æ•°

// AI äº’åŠ¨å¡ç‰‡
AICardInstance; // AI å¡ç‰‡å®ä¾‹
AICardCreateAndDeliverRequest; // åˆ›å»ºå¹¶æŠ•æ”¾å¡ç‰‡è¯·æ±‚
AICardStreamingRequest; // æµå¼æ›´æ–°è¯·æ±‚
AICardStatus; // å¡ç‰‡çŠ¶æ€å¸¸é‡

// å·¥å…·å‡½æ•°ç±»å‹
Logger; // æ—¥å¿—æ¥å£
RetryOptions; // é‡è¯•é€‰é¡¹
MediaFile; // ä¸‹è½½çš„åª’ä½“æ–‡ä»¶
```

### å…¬å¼€ API

æ’ä»¶å¯¼å‡ºä»¥ä¸‹ä½çº§ API å‡½æ•°ï¼Œå¯ç”¨äºè‡ªå®šä¹‰é›†æˆï¼š

```typescript
// æ–‡æœ¬/Markdown æ¶ˆæ¯
sendBySession(config, sessionWebhook, text, options); // é€šè¿‡ä¼šè¯å‘é€

// AI äº’åŠ¨å¡ç‰‡
createAICard(config, conversationId, data, log); // åˆ›å»ºå¹¶æŠ•æ”¾ AI å¡ç‰‡
streamAICard(card, content, finished, log); // æµå¼æ›´æ–°å¡ç‰‡å†…å®¹
finishAICard(card, content, log); // å®Œæˆå¹¶å…³é—­å¡ç‰‡

// è‡ªåŠ¨æ¨¡å¼é€‰æ‹©
sendMessage(config, conversationId, text, options); // æ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©ï¼ˆå«å¡ç‰‡/æ–‡æœ¬å›é€€ï¼‰

// è®¤è¯
getAccessToken(config, log); // è·å–è®¿é—®ä»¤ç‰Œ
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
import { createAICard, streamAICard, finishAICard } from './src/channel';

// åˆ›å»º AI å¡ç‰‡
const card = await createAICard(config, conversationId, messageData, log);

// æµå¼æ›´æ–°å†…å®¹
for (const chunk of aiResponseChunks) {
  await streamAICard(card, currentText + chunk, false, log);
}

// å®Œæˆå¹¶å…³é—­å¡ç‰‡
await finishAICard(card, finalText, log);
```

### æ¶æ„

æ’ä»¶éµå¾ª Telegram å‚è€ƒå®ç°çš„æ¶æ„æ¨¡å¼ï¼š

- **index.ts**: æœ€å°åŒ–æ’ä»¶æ³¨å†Œå…¥å£
- **src/channel.ts**: æ‰€æœ‰ DingTalk ç‰¹å®šçš„é€»è¾‘ï¼ˆAPIã€æ¶ˆæ¯å¤„ç†ã€é…ç½®ç­‰ï¼‰
- **src/runtime.ts**: è¿è¡Œæ—¶ç®¡ç†ï¼ˆgetter/setterï¼‰
- **src/types.ts**: ç±»å‹å®šä¹‰
- **utils.ts**: é€šç”¨å·¥å…·å‡½æ•°

## æµ‹è¯•

é¡¹ç›®å·²åŸºäº Vitest åˆå§‹åŒ–è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```text
tests/
  unit/
    sign.test.ts               # HmacSHA256 + Base64 ç­¾åæµ‹è¯•
    message-transform.test.ts  # æ–‡æœ¬/Markdown æ¶ˆæ¯è½¬æ¢æµ‹è¯•
  integration/
    send-lifecycle.test.ts     # æ’ä»¶ outbound.sendText ç”Ÿå‘½å‘¨æœŸé€‚é…æµ‹è¯•
```

### è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…ä¾èµ–ï¼ˆpnpmï¼‰
pnpm install

# è¿è¡Œå…¨éƒ¨æµ‹è¯•
pnpm test

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼ˆcoverage/ï¼‰
pnpm test:coverage
```

### Mock çº¦æŸ

- æ‰€æœ‰æµ‹è¯•ä¸­çš„ç½‘ç»œè¯·æ±‚å‡é€šè¿‡ `vi.mock('axios')` æ‹¦æˆªï¼Œç¦æ­¢çœŸå®è°ƒç”¨é’‰é’‰ APIã€‚
- é›†æˆæµ‹è¯•é€šè¿‡æ¨¡å— mock éš”ç¦» `openclaw/plugin-sdk`ã€`dingtalk-stream` ç­‰å¤–éƒ¨ä¾èµ–ã€‚

## è®¸å¯

MIT
